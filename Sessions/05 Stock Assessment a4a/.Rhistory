fit <- sca(ple4, ple4.indices)
res <- residuals(fit, ple4, ple4.indices)
plot(res, main="Residuals")
stk <- ple4 + fit
plot(stk, main="Stock summary")
wireframe(data ~ age + year, data = as.data.frame(harvest(stk)), drape = TRUE, main="Fishing mortality", screen = list(x = -90, y=-45))
wireframe(data ~ age + year, data = as.data.frame(stock.n(stk)), drape = TRUE, main="Population", screen = list(x = -90, y=-45))
wireframe(data ~ age + year, data = as.data.frame(catch.n(stk)), drape = TRUE, main="Catches")
showClass("a4aFit")
plotS4("a4aFit", main="a4aFit class", lwd = 1, box.lwd = 2, cex.txt = 0.8, box.size = 0.1, box.type = "square", box.prop = 0.3)
qmodel <- list(~ factor(age))
qmodel
fmodel <- ~ factor(age) + factor(year)
fit <- sca(stock = ple4, indices = ple4.indices[1], fmodel=fmodel, qmodel=qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ s(age, k=4) + s(year, k = 20)
fit1 <- sca(ple4, ple4.indices[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit1)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ s(age, k=4) + s(year, k = 20) + te(age, year, k = c(3,3))
fit3 <- sca(ple4, ple4.indices[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit3)), drape = TRUE, screen = list(x = -90, y=-45))
mean(range(ple4.indices[[1]])[c("startf", "endf")])
sfrac <- mean(range(ple4.indices[[1]])[c("startf", "endf")])
fmodel <- ~ factor(age) + factor(year)
qmodel <- list(~ factor(age))
fit <- sca(ple4, ple4.indices[1], fmodel, qmodel)
Z <- (m(ple4) + harvest(fit))*sfrac # check M * sfrac
lst <- dimnames(fit@index[[1]])
lst$x <- stock.n(fit)*exp(-Z)
stkn <- do.call("trim", lst)
wireframe(data ~ age + year, data = as.data.frame(index(fit)[[1]]/stkn), drape = TRUE, screen = list(x = -90, y=-45))
qmodel <- list(~ s(age, k=4))
fit1 <- sca(ple4, ple4.indices[1], fmodel, qmodel)
Z <- (m(ple4) + harvest(fit1))*sfrac
lst <- dimnames(fit1@index[[1]])
lst$x <- stock.n(fit1)*exp(-Z)
stkn <- do.call("trim", lst)
wireframe(data ~ age + year, data = as.data.frame(index(fit1)[[1]]/stkn), drape = TRUE, screen = list(x = -90, y=-45))
qmodel <- list(~ te(age, year, k = c(3,40)))
fit2 <- sca(ple4, ple4.indices[1], fmodel, qmodel)
Z <- (m(ple4) + harvest(fit2))*sfrac
lst <- dimnames(fit2@index[[1]])
lst$x <- stock.n(fit2)*exp(-Z)
stkn <- do.call("trim", lst)
wireframe(data ~ age + year, data = as.data.frame(index(fit2)[[1]]/stkn), drape = TRUE, screen = list(x = -90, y=-45))
qmodel <- list( ~ s(age, k=4) + year)
fit3 <- sca(ple4, ple4.indices[1], fmodel, qmodel)
Z <- (m(ple4) + harvest(fit3))*sfrac
lst <- dimnames(fit3@index[[1]])
lst$x <- stock.n(fit3)*exp(-Z)
stkn <- do.call("trim", lst)
wireframe(data ~ age + year, data = as.data.frame(index(fit3)[[1]]/stkn), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ s(age, k=4) + s(year, k = 20)
qmodel <- list(~ s(age, k=4))
srmodel <- ~ factor(year)
fit <- sca(ple4, ple4.indices[1], fmodel=fmodel, qmodel=qmodel, srmodel=srmodel)
srmodel <- ~ s(year, k=20)
fit1 <- sca(ple4, ple4.indices[1], fmodel, qmodel, srmodel)
srmodel <- ~ ricker(CV=0.05)
fit2 <- sca(ple4, ple4.indices[1], fmodel, qmodel, srmodel)
srmodel <- ~ bevholt(CV=0.05)
fit3 <- sca(ple4, ple4.indices[1], fmodel, qmodel, srmodel)
srmodel <- ~ hockey(CV=0.05)
fit4 <- sca(ple4, ple4.indices[1], fmodel, qmodel, srmodel)
srmodel <- ~ geomean(CV=0.05)
fit5 <- sca(ple4, ple4.indices[1], fmodel, qmodel, srmodel)
flqs <- FLQuants(fac=stock.n(fit)[1], bh=stock.n(fit3)[1])
xyplot(data~year, groups=qname, data=flqs, type="l", main="Recruitment models", auto.key=keylst)
fmodel <- ~ s(age, k=4) + s(year, k = 20)
qmodel <- list( ~ s(age, k=4) + year)
srmodel <- ~s(year, k=20)
fit <- a4aSCA(ple4, ple4.indices[1], fmodel, qmodel, srmodel)
n1model <- ~s(age, k=4)
fit1 <- a4aSCA(ple4, ple4.indices[1], fmodel, qmodel, srmodel, n1model)
flqs <- FLQuants(smo=stock.n(fit1)[,1], fac=stock.n(fit)[,1])
xyplot(data~age, groups=qname, data=flqs, type="l", main="N1 models", auto.key=keylst)
vmodel <- list(~1, ~1)
fit <- a4aSCA(ple4, ple4.indices[1], fmodel, qmodel, srmodel, n1model, vmodel)
vmodel <- list(~ s(age, k=5), ~1)
fit1 <- a4aSCA(ple4, ple4.indices[1], fmodel, qmodel, srmodel, n1model, vmodel)
flqs <- FLQuants(cts=catch.n(fit), smo=catch.n(fit1))
xyplot(data~year|age, groups=qname, data=flqs, type="l", main="Variance models", scales=list(y=list(relation="free")), auto.key=keylst)
predict(fit)$vmodel$catch
wireframe(data ~ age + year, data = as.data.frame(predict(fit1)$vmodel$catch), drape = TRUE, screen = list(x = -90, y=-45))
data(ple4)
data(ple4.indices)
stk <- ple4
idx <- ple4.indices[1]
varslt <- catch.n(stk)
varslt[] <- 1
catch.n(stk) <- FLQuantDistr(catch.n(stk), varslt) # show: remove var
index(idx[[1]])
varslt <- index(idx[[1]])
varslt[] <- 0.05
index.var(idx[[1]]) <- varslt
index.var(idx[[1]])
fit <- a4aSCA(ple4, ple4.indices[1], vmodel=list(~1, ~1))
fit1 <- a4aSCA(stk, idx, vmodel=list(~1, ~1))
flqs <- FLQuants(nowgt=stock.n(fit), extwgt=stock.n(fit1))
xyplot(data~year|age, groups=qname, data=flqs, type="l", main="Likelihood weighting", scales=list(y=list(relation="free")), auto.key=keylst)
showClass("a4aGr")
vb <- ~linf*(1-exp(-k*(t-t0)))
inverse_vb <- ~t0-1/k*log(1-len/linf)
class(vb)
vb_params <- FLPar(linf=58.5, k=0.086, t0=0.001,
units=c("cm","ano-1","ano"))
vb_gr <- a4aGr(grMod=vb, grInvMod=inverse_vb,
params=vb_params)
vb_gr
vb_gr <- a4aGr(grMod=vb, grInvMod=inverse_vb,
params=vb_params)
vb_gr
grMod(vb_gr)
grInvMod(vb_gr)
params(vb_gr)
dim(params(vb_gr))
plot(vb_gr)
dim(params(vb_gr))
predict(vb_gr, len=20) #  note that the argument has the same name as the parameter in the growth model
predict(vb_gr, t=5) # Using the inverse model
predict(vb_gr, t=predict(vb_gr, len=20)) # model into the inverse model (sanity check)
predict(vb_gr, len=5:10+0.5)
predict(vb_gr, t=5:10+0.5)
predict(vb_gr, t=predict(vb_gr, len=5:10+0.5))
varcov <- matrix(NA, ncol=3, nrow=3)
diag(varcov) <- c(100, 0.001,0.001)
varcov
diag(varcov) <- c(100, 0.001,0.001)
varcov[upper.tri(varcov)] <- varcov[lower.tri(varcov)] <- c(0.1,0.1,0.0003)
varcov
setwd("~/GitHub/stock_assessment_summer_school_Module2/Sessions/05 Stock Assessment a4a")
getWd()
getwd()
load("~/GitHub/stock_assessment_summer_school_Module2/Material/stocks_for_course/HKE9_11_at_Age/HKE_09_10_11_EWG15_11.RData")
load("~/GitHub/stock_assessment_summer_school_Module2/Material/stocks_for_course/HKE9_11_at_Age/index_HKE_09-10-11_EWG15_11.RData")
source("funs.R")
keylst <- list(points=FALSE, lines=TRUE, space="right")
hke.idx <- index_HKE_09-10-11_EWG15_11
hke.idx <- "index_HKE_09-10-11_EWG15_11"
hke.idx
hke.idx <- 'index_HKE_09-10-11_EWG15_11'
hke.idx
load("~/GitHub/stock_assessment_summer_school_Module2/Material/stocks_for_course/HKE9_11_at_Age/index_HKE_09_10_11_EWG15_11.RData")
hke.idx <- 'index_HKE_09_10_11_EWG15_11
''
""
"""'''
hke.idx <- index_HKE_09_10_11_EWG15_11
plot(index_HKE_09-10-11_EWG15_11)[[1]]
load("~/GitHub/stock_assessment_summer_school_Module2/Material/stocks_for_course/HKE9_11_at_Age/HKE_09_10_11_idx.Rdata")
load("~/GitHub/stock_assessment_summer_school_Module2/Material/stocks_for_course/HKE9_11_at_Age/HKE_09_10_11_EWG15_11.RData")
hke <- HKE_09_10_11_EWG15_11
hke.idx <- flq.idx
fit <- sca(hke, hke.idx)
res <- residuals(fit, hke, hke.idx)
plot(res, main="Residuals")
bubbles(res)
qqmath(res)
stk <- hke + fit
plot(stk, main="Stock summary")
wireframe(data ~ age + year, data = as.data.frame(harvest(stk)), drape = TRUE, main="Fishing mortality", screen = list(x = -90, y=-45))
plot(stk, main="Stock summary")
wireframe(data ~ age + year, data = as.data.frame(harvest(stk)), drape = TRUE, main="Fishing mortality", screen = list(x = 90, y=-45))
wireframe(data ~ age + year, data = as.data.frame(harvest(stk)), drape = TRUE, main="Fishing mortality", screen = list(x = -90, y=-90))
wireframe(data ~ age + year, data = as.data.frame(harvest(stk)), drape = TRUE, main="Fishing mortality", screen = list(x = -50, y=-45))
harvest(stk.n)
harvest(stk)
catch.n(stk)
wireframe(data ~ age + year, data = as.data.frame(harvest(HKE_09_10_11_EWG15_11)), drape = TRUE, main="Fishing mortality", screen = list(x = -50, y=-45))
wireframe(data ~ age + year, data = as.data.frame(harvest(HKE_09_10_11_EWG15_11)), drape = TRUE, main="Fishing mortality", screen = list(x = -90, y=-45))
fit <- sca(hke, hke.idx)
stk <- hke + fit
plot(stk, main="Stock summary")
plot(HKE_09_10_11_EWG15_11)
range(stk)
qmodel <- list(~ factor(age))
fmodel <- ~ factor(age) + factor(year)
fit <- sca(stock = hke, indices = hke.idx[1], fmodel=fmodel, qmodel=qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ s(age, k=4) + s(year, k = 20)
fit1 <- sca(hke, hke.idx[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit1)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ s(age, k=4) + s(year, k = 10)
fit1 <- sca(hke, hke.idx[1], fmodel, qmodel)
fmodel <- ~ s(age, k=4) + s(year, k = 5)
fit1 <- sca(hke, hke.idx[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit1)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ te(age, year, k = c(4,5))
fit2 <- sca(hke, hke.idx[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit2)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ s(age, k=4) + s(year, k = 5) + te(age, year, k = c(3,3))
fit3 <- sca(hke, hke.idx[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit3)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ te(age, year, k = c(4,5)) + s(year, k = 5, by = as.numeric(age==1))
fit4 <- sca(hke, hke.idx[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit4)), drape = TRUE, screen = list(x = -90, y=-45))
sfrac <- mean(range(hke.idx[[1]])[c("startf", "endf")])
fmodel <- ~ factor(age) + factor(year)
qmodel <- list(~ factor(age))
fit <- sca(hke, hke.idx[1], fmodel, qmodel)
Z <- (m(hke) + harvest(fit))*sfrac # check M * sfrac
lst <- dimnames(fit@index[[1]])
lst$x <- stock.n(fit)*exp(-Z)
stkn <- do.call("trim", lst)
wireframe(data ~ age + year, data = as.data.frame(index(fit)[[1]]/stkn), drape = TRUE, screen = list(x = -90, y=-45))
qmodel <- list(~ s(age, k=4))
fit1 <- sca(hke, hke.idx[1], fmodel, qmodel)
Z <- (m(hke) + harvest(fit1))*sfrac
lst <- dimnames(fit1@index[[1]])
lst$x <- stock.n(fit1)*exp(-Z)
stkn <- do.call("trim", lst)
wireframe(data ~ age + year, data = as.data.frame(index(fit1)[[1]]/stkn), drape = TRUE, screen = list(x = -90, y=-45))
qmodel <- list( ~ s(age, k=4) + year)
fit3 <- sca(hke, hke.idx[1], fmodel, qmodel)
Z <- (m(hke) + harvest(fit3))*sfrac
lst <- dimnames(fit3@index[[1]])
lst$x <- stock.n(fit3)*exp(-Z)
stkn <- do.call("trim", lst)
wireframe(data ~ age + year, data = as.data.frame(index(fit3)[[1]]/stkn), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ s(age, k=4) + s(year, k = 5)
qmodel <- list(~ s(age, k=4))
srmodel <- ~ factor(year)
fit <- sca(hke, hke.idx[1], fmodel=fmodel, qmodel=qmodel, srmodel=srmodel)
srmodel <- ~ s(year, k=20)
fit1 <- sca(hke, hke.idx[1], fmodel, qmodel, srmodel)
srmodel <- ~ ricker(CV=0.05)
fit2 <- sca(hke, hke.idx[1], fmodel, qmodel, srmodel)
srmodel <- ~ bevholt(CV=0.05)
fit3 <- sca(hke, hke.idx[1], fmodel, qmodel, srmodel)
srmodel <- ~ s(year, k=5)
fit1 <- sca(hke, hke.idx[1], fmodel, qmodel, srmodel)
srmodel <- ~ bevholt(CV=0.05)
fit3 <- sca(hke, hke.idx[1], fmodel, qmodel, srmodel)
srmodel <- ~ hockey(CV=0.05)
fit4 <- sca(hke, hke.idx[1], fmodel, qmodel, srmodel)
srmodel <- ~ geomean(CV=0.05)
fit5 <- sca(hke, hke.idx[1], fmodel, qmodel, srmodel)
flqs <- FLQuants(fac=stock.n(fit)[1], bh=stock.n(fit3)[1])
xyplot(data~year, groups=qname, data=flqs, type="l", main="Recruitment models", auto.key=keylst)
plot(flqs)
plot(as.FLIndices(flqs))
xyplot(data~year, groups=qname, data=flqs, type="l"
)
xyplot(data~year, groups=qname, data=flqs, type="l", main="Recruitment models", auto.key = keylst)
keylst <- list(points=FALSE, lines=TRUE, space="right")
xyplot(data~year, groups=qname, data=flqs, type="l", main="Recruitment models", auto.key = keylst)
fmodel <- ~ s(age, k=4) + s(year, k = 5)
qmodel <- list( ~ s(age, k=4) + year)
srmodel <- ~s(year, k=8)
fit <- a4aSCA(hke, hke.idx[1], fmodel, qmodel, srmodel)
plot(stk+fit)
fmod1 <- ~factor(year) + factor(age)
qmod1 <- list(~factor(age), ~factor(age),~factor(age),~factor(age))
srmod1 <- ~factor(year)
fit1 <- sca(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
qmod <- list(~factor(age), ~factor(age),~factor(age))
fit2 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
fmod <- ~factor(year) + factor(age)
fit2 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
qmod <- list(~s(age, k=3), ~s(age, k=3))
fit3 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
qmod1 <- list(~factor(age))
fit1 <- sca(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
fit1 <- sca(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1)
qmod1
fmodel <- ~ s(age, k=4) + s(year, k = 5)
qmodel <- list(~ s(age, k=4))
srmodel <- ~ factor(year)
fit1 <- sca(stock = stk, indices = flq.idx[1], qmodel=qmod1,fmodel = fmod1)
fmod <- ~factor(year) + factor(age)
qmod1 <- list(~factor(age))
srmod1 <- ~factor(year)
fit1 <- sca(stock = stk, indices = flq.idx[1], qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
qmod <- list(~factor(age), ~factor(age),~factor(age))
fit2 <- sca(stock = stk, indices = flq.idx[1], fmodel = fmod, qmodel = qmod,  fit = "assessment")
qmod <- list(~s(age, k=3), ~s(age, k=3))
fit3 <- sca(stock = stk, indices = flq.idx[1], fmodel = fmod, qmodel = qmod,  fit = "assessment")
fmod <- ~s(year, k=5) + s(age, k=3)
qmod <- list(~s(age, k=3), ~s(age, k=3))
fit4 <- sca(stock = stk, indices = flq.idx[1], fmodel = fmod, qmodel = qmod,  fit = "assessment")
fmod <- ~s(year, k=5) + s(age, k=3)+ s(year, by= as.numeric(age==0), k=5)
fit5 <- sca(stock = stk, indices = flq.idx[1], fmodel = fmod, qmodel = qmod,  fit = "assessment")
qmodel <- list(~ te(age, year, k = c(5,10)), ~ te(age, year, k = c(5,10)))
fit6 <- sca(stock = stk, indices = flq.idx[1], fmodel = fmod, qmodel = qmod,  fit = "assessment")
fmod <- ~s(year, k=10) + s(age,  k=5) + s(year, by= as.numeric(age==0), k=5)
qmod <- list(~s(age, k=3), ~s(age, k=3))
fit7 <- sca(stock = stk, indices = flq.idx[1], fmodel = fmod, qmodel = qmod,  fit = "assessment")
fmod10 <- ~ te(age, year, k = c(3,5))+ s(year, k = 5, by = as.numeric(age==0))
qmod1 <- list(~factor(age), ~factor(age),~factor(age),~factor(age))
qmod12<- list(~ factor(replace(age, age>3,3) ), ~ factor(replace(age, age>3,3) ),~ factor(replace(age, age>3,3) ),~ factor(replace(age, age>3,3) ))
fmod12<- ~factor(replace(age, age>3,3)) + s(year, k=5)
fit8 <- sca(stock = stk, indices = flq.idx[1], fmodel = fmod12, qmodel = qmod12, srmodel=srmod1,  fit = "assessment")
plot(stk + fit8)
plot(fit7, stk)
res <- residuals( fit8, stk, flq.idx)
res <- residuals( fit8, stk, flq.idx[1])
plot(res)
hke.idx[[1]]
hke.idx[[2]]
hke.idx[[3]]
hke.idx[[4]]
fmod <- ~factor(year) + factor(age)
qmod1 <- list(~factor(age))
srmod1 <- ~factor(year)
fit1 <- sca(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
fit1 <- sca(stock = stk, indices = flq.idx, fmodel = fmod1,  fit = "assessment")
fit1 <- sca(stock = stk, indices = flq.idx)
plot(hke+fit)
str(flq.idx)
name(flq.idx[[1]])
name(flq.idx[[2]])
name(flq.idx[[3]])
name(flq.idx[[4]])
range(flq.idx[[1]]
)
spe <<- "M. merluccius"
rage_SETTING <<- 0 # q independent to stock size
qage_SETTING <<- 5
min_Fbar <<-  1
max_Fbar <<- 4
plus_GROUP <<-  6
timeseries <<- c(2006:2014)
retro.years <<- c(2011:2013)
units(catch(stk)) <- "t"
units(catch.n(stk)) <- "10^3"
units(catch.wt(stk)) <- "kg"
units(stock.n(stk)) <- "10^3"
units(stock.wt(stk)) <- "kg"
plot(catch.n(stk))
units(harvest(stk))<-"f"
range(stk)["minfbar"] <- min_Fbar
range(stk)["maxfbar"] <- max_Fbar
stk <- setPlusGroup(stk, 6)
FLXSA.control.spe_05 <- FLXSA.control(x=NULL, tol=1e-09, maxit=30, min.nse=0.3, fse=0.5,
rage=rage_SETTING, qage=qage_SETTING, shk.n=TRUE, shk.f=TRUE, shk.yrs=3, shk.ages=2,
window=100, tsrange=20, tspower=3, vpa=FALSE)
library(FLXSA)
FLXSA.control.spe_05 <- FLXSA.control(x=NULL, tol=1e-09, maxit=30, min.nse=0.3, fse=0.5,
rage=rage_SETTING, qage=qage_SETTING, shk.n=TRUE, shk.f=TRUE, shk.yrs=3, shk.ages=2,
window=100, tsrange=20, tspower=3, vpa=FALSE)
FLXSA.control.spe_1 <- FLXSA.control(x=NULL, tol=1e-09, maxit=30, min.nse=0.3, fse=1,
rage=rage_SETTING, qage=qage_SETTING, shk.n=TRUE, shk.f=TRUE, shk.yrs=3, shk.ages=2,
window=100, tsrange=20, tspower=3, vpa=FALSE)
FLXSA.control.spe_15 <- FLXSA.control(x=NULL, tol=1e-09, maxit=30, min.nse=0.3, fse=1.5,
rage=rage_SETTING, qage=qage_SETTING, shk.n=TRUE, shk.f=TRUE, shk.yrs=3, shk.ages=2,
window=100, tsrange=20, tspower=3, vpa=FALSE)
FLXSA.control.spe_2 <- FLXSA.control(x=NULL, tol=1e-09, maxit=30, min.nse=0.3, fse=2,
rage=rage_SETTING, qage=qage_SETTING, shk.n=TRUE, shk.f=TRUE, shk.yrs=3, shk.ages=2,
window=100, tsrange=20, tspower=3, vpa=FALSE)
FLXSA.control.spe_25 <- FLXSA.control(x=NULL, tol=1e-09, maxit=30, min.nse=0.3, fse=2.5,
rage=rage_SETTING, qage=qage_SETTING, shk.n=TRUE, shk.f=TRUE, shk.yrs=3, shk.ages=2,
window=100, tsrange=20, tspower=3, vpa=FALSE)
FLXSA.control.spe_3 <- FLXSA.control(x=NULL, tol=1e-09, maxit=30, min.nse=0.3, fse=3,
rage=rage_SETTING, qage=qage_SETTING, shk.n=TRUE, shk.f=TRUE, shk.yrs=3, shk.ages=2,
window=100, tsrange=20, tspower=3, vpa=FALSE)
spe.xsa_05 <- FLXSA(stk, flq.idx, FLXSA.control.spe_05)
spe.xsa_1 <- FLXSA(stk, flq.idx, FLXSA.control.spe_1)
spe.xsa_15 <- FLXSA(stk, flq.idx, FLXSA.control.spe_15)
spe.xsa_2 <- FLXSA(stk, flq.idx, FLXSA.control.spe_2)
spe.xsa_25 <- FLXSA(stk, flq.idx, FLXSA.control.spe_25)
spe.xsa_3 <- FLXSA(stk, flq.idx, FLXSA.control.spe_3)
spe.stk_05 <- stk+spe.xsa_05
spe.stk_1 <- stk+spe.xsa_1
spe.stk_15 <- stk+spe.xsa_15
spe.stk_2 <- stk+spe.xsa_2
spe.stk_25 <- stk+spe.xsa_25
spe.stk_3 <- stk+spe.xsa_3
stocks<-FLStocks(spe.stk_05,spe.stk_1,spe.stk_15,spe.stk_2,spe.stk_25,spe.stk_3)
names(stocks)<-c("shr0.5", "shr1", "shr1.5", "shr2", "shr2.5", "shr3")
plot(stocks)
diagnostics(spe.xsa_3)
ffff<-index.res(spe.xsa_2)
names(ffff)<-c("Medits_SA10", "LLS_CPUE_SA10", "Medits_SA9", "Medits_SA11")
bubbles(age ~ year|qname, data = index.res(spe.xsa_05) , main = "Log catchability residuals sh 05")
spe.stk.retro_05 <- tapply(retro.years,1:length(retro.years),function(x)return(window(stk,end=x)+FLXSA(window(stk,end=x),flq.idx,FLXSA.control.spe_05)))
spe.stk.retro_1 <-  tapply(retro.years,1:length(retro.years),function(x)return(window(stk,end=x)+FLXSA(window(stk,end=x),flq.idx,FLXSA.control.spe_1)))
spe.stk.retro_15 <-  tapply(retro.years,1:length(retro.years),function(x)return(window(stk,end=x)+FLXSA(window(stk,end=x),flq.idx,FLXSA.control.spe_15)))
spe.stk.retro_2 <- tapply(retro.years,1:length(retro.years),function(x)return(window(stk,end=x)+FLXSA(window(stk,end=x),flq.idx,FLXSA.control.spe_2)))
spe.stk.retro_25 <-  tapply(retro.years,1:length(retro.years),function(x)return(window(stk,end=x)+FLXSA(window(stk,end=x),flq.idx,FLXSA.control.spe_25)))
spe.stk.retro_3 <- tapply(retro.years,1:length(retro.years),function(x)return(window(stk,end=x)+FLXSA(window(stk,end=x),flq.idx,FLXSA.control.spe_3)))
spe.stk.retro_05 <- FLStocks(spe.stk.retro_05)
spe.stk.retro_1 <- FLStocks(spe.stk.retro_1)
spe.stk.retro_15 <- FLStocks(spe.stk.retro_15)
spe.stk.retro_2 <- FLStocks(spe.stk.retro_2)
spe.stk.retro_25 <- FLStocks(spe.stk.retro_25)
spe.stk.retro_3 <- FLStocks(spe.stk.retro_3)
plot(spe.stk.retro_05)
fit1 <- sca(stk, FLIndices(flq.idx), qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
qmod1
qmod1 <- list(~factor(age), ~factor(age), ~factor(age), ~factor(age))
fit1 <- sca(stk, FLIndices(flq.idx), qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
qmod <- list(~factor(age), ~factor(age),~factor(age))
fit2 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
qmod <- list(~factor(age), ~factor(age),~factor(age),~factor(age))
fit2 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
qmod <- list(~s(age, k=3), ~s(age, k=3))
fit3 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
plot(spe.stk_25)
fmod1 <- ~factor(year) + factor(age)
qmod1 <- list(~factor(age), ~factor(age), ~factor(age), ~factor(age))
srmod1 <- ~factor(year)
fit1 <- sca(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
fit1 <- sca(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "MP")
plot(hke+fit)
fit1 <- a4aSca(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
fit1 <- a4asca(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
fit1 <- A4asca(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
fit1 <- a4aFit(stock = stk, indices = flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
fit1 <- a4aFit(stk, flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
fit1 <- a4aSCA(stk, flq.idx, qmodel=qmod1,fmodel = fmod1,  fit = "assessment")
submodels(fit1)
fmod <- ~s(year, k=5) + s(age, k=3)
qmod <- list(~s(age, k=3), ~s(age, k=3))
fit4 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
qmod <- list(~s(age, k=3), ~s(age, k=3),~s(age, k=3), ~s(age, k=3))
fit4 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
qmod <- list(~s(age, k=3), ~s(age, k=3),~s(age, k=3), ~s(age, k=3))
qmodel <- list(~ te(age, year, k = c(5,10)), ~ te(age, year, k = c(5,10)))
fit6 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
fit6 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmod = qmodel,  fit = "assessment")
qmodel <- list(~ te(age, year, k = c(5,5)), ~ te(age, year, k = c(5,5)))
fit6 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmod = qmodel,  fit = "assessment")
qmodel <- list(~ te(age, year, k = c(5,5)), ~ te(age, year, k = c(5,5)),~ te(age, year, k = c(5,5)), ~ te(age, year, k = c(5,5)))
fit6 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmod = qmodel,  fit = "assessment")
plot(hke+fit6)
fmod <- ~s(year, k=10) + s(age,  k=5) + s(year, by= as.numeric(age==0), k=5)
qmod <- list(~s(age, k=3), ~s(age, k=3),~s(age, k=3), ~s(age, k=3))
fit7 <- sca(stock = stk, indices = flq.idx, fmodel = fmod, qmodel = qmod,  fit = "assessment")
load("~/GitHub/stock_assessment_summer_school_Module2/Material/stocks_for_course/HKE9_11_at_Age/HKE_09_10_11_EWG15_11.RData")
load("~/GitHub/stock_assessment_summer_school_Module2/Material/stocks_for_course/HKE9_11_at_Age/HKE_09_10_11_idx.Rdata")
source("funs.R")
keylst <- list(points=FALSE, lines=TRUE, space="right")
hke <- HKE_09_10_11_EWG15_11
hke.idx <- flq.idx
fit <- sca(hke, hke.idx)
res <- residuals(fit, hke, hke.idx)
plot(res, main="Residuals")
fit <- sca(hke, hke.idx[1])
res <- residuals(fit, hke, hke.idx[1])
plot(res, main="Residuals")
bubbles(res)
qqmath(res)
stk <- hke + fit
plot(stk, main="Stock summary")
wireframe(data ~ age + year, data = as.data.frame(harvest(stk)), drape = TRUE, main="Fishing mortality", screen = list(x = -90, y=-45))
catch.n(hke)
units(harvest(hke))<-"f"
range(hke)["minfbar"] <- 0
range(hke)["maxfbar"] <- 3
fit <- sca(hke, hke.idx[1])
fit <- sca(hke, hke.idx[1],fit = "assessment")
fit <- sca(hke, hke.idx,fit = "assessment")
res <- residuals(fit, hke, hke.idx)
plot(res, main="Residuals")
bubbles(res)
stk <- hke + fit
plot(stk, main="Stock summary")
wireframe(data ~ age + year, data = as.data.frame(harvest(stk)), drape = TRUE, main="Fishing mortality", screen = list(x = -90, y=-45))
wireframe(data ~ age + year, data = as.data.frame(stock.n(stk)), drape = TRUE, main="Population", screen = list(x = -90, y=-45))
wireframe(data ~ age + year, data = as.data.frame(catch.n(stk)), drape = TRUE, main="Catches")
plot(fit, hke)
plot(fit, hke.idx)
plot(fit, hke.idx[2])
plot(fit, hke.idx)
plot(fit, hke.idx[1])
plot(fit, hke.idx[4])
plotS4("SCAPars", main="SCAPars class", lwd = 1, box.lwd = 2, cex.txt = 0.8, box.size = 0.1, box.type = "square", box.prop = 0.3)
fmodel <- ~ factor(age) + factor(year)
fit <- sca(stock = hke, indices = hke.idx, fmodel=fmodel, qmodel=qmodel)
qmodel <- list(~ factor(age), ~ factor(age), ~ factor(age), ~ factor(age))
fmodel <- ~ factor(age) + factor(year)
fit <- sca(stock = hke, indices = hke.idx, fmodel=fmodel, qmodel=qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ factor(age) + factor(year)
fit <- sca(stock = hke, indices = hke.idx, fmodel=fmodel, qmodel=qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ s(age, k=4) + s(year, k = 5)
fit1 <- sca(hke, hke.idx[1], fmodel, qmodel)
fit1 <- sca(hke, hke.idx, fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit1)), drape = TRUE, screen = list(x = -90, y=-45))
plot(hke, fit1)
plot(hke + fit1)
plot( fit1, hke)
plot( fit1, hke.idx)
fmodel <- ~ te(age, year, k = c(4,5))
fit2 <- sca(hke, hke.idx[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit2)), drape = TRUE, screen = list(x = -90, y=-45))
fmodel <- ~ te(age, year, k = c(3,5))
fit2 <- sca(hke, hke.idx[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit2)), drape = TRUE, screen = list(x = -90, y=-45))
plot( fit2, hke.idx)
plot( fit2, hke)
fmodel <- ~ s(age, k=4) + s(year, k = 5) + te(age, year, k = c(3,3))
fit3 <- sca(hke, hke.idx[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit3)), drape = TRUE, screen = list(x = -90, y=-45))
plot(hke+fit3)
plot(fit3)
plot(fit3, hke)
res <- residuals(fit3, hke, hke.idx)
plot(res, main="Residuals")
fmodel <- ~ te(age, year, k = c(4,5)) + s(year, k = 5, by = as.numeric(age==1))
fit4 <- sca(hke, hke.idx[1], fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit4)), drape = TRUE, screen = list(x = -90, y=-45))
fit3 <- sca(hke, hke.idx, fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit3)), drape = TRUE, screen = list(x = -90, y=-45))
fit4 <- sca(hke, hke.idx[1], fmodel, qmodel)
fmodel <- ~ te(age, year, k = c(4,5)) + s(year, k = 5, by = as.numeric(age==1))
fit4 <- sca(hke, hke.idx, fmodel, qmodel)
wireframe(data ~ age + year, data = as.data.frame(harvest(fit4)), drape = TRUE, screen = list(x = -90, y=-45))
res <- residuals(fit4, hke, hke.idx)
plot(res, main="Residuals")
install.packages("mpb", repos="http://flr-project.org/R")
